{% extends 'base.html' %}
{% from "bootstrap5/form.html" import render_form %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='style/eventDetails.css') }}">
{% endblock %}

{% block content %}
<main>
    {% if event %}
    <div class="row creation-banner">
        <div class="col-sm-12">
            <div class="Title text-center justify-content-center py-3">
                <h1>{{ event.name | default('Event Name Not Available') }}</h1>
                <h2>Status: {{ event.status | default('N/A') }}</h2>
            </div>

            {% if event.image_filename %}
            <div id="eventImageCarousel" class="carousel slide mb-4">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="{{ url_for('static', filename=event.image_filename) }}" class="d-block w-100" alt="{{ event.name }} Image" style="max-height: 700px; object-fit: contain;">
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-3">
                <p>No image available for this event.</p>
                <img src="{{ url_for('static', filename='img/grey.jpg') }}" class="d-block w-50 mx-auto" alt="Placeholder Image" style="max-height: 400px; object-fit: contain;">
            </div>
            {% endif %}
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12 col-lg-6">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Ticket Information:</h5>
                        {% if event.ticket_types.all() %}
                            <ul>
                            {% for ticket in event.ticket_types %}
                                <li>
                                    <strong>{{ ticket.type_name }}:</strong> ${{ "%.2f"|format(ticket.price) }} 
                                    (Available: {{ ticket.quantity_available }}) <br>
                                    <em>{{ ticket.description | default('')}}</em>
                                </li>
                            {% endfor %}
                            </ul>
                        {% else %}
                            <p>Ticket information not yet available or this event might be free.</p>
                        {% endif %}
                        <a href="#" class="btn btn-primary mt-3">Book Tickets (Placeholder)</a>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Event Details:</h5>
                        <p><strong>Date & Time:</strong> {{ event.start_datetime.strftime('%A, %B %d, %Y at %I:%M %p') if event.start_datetime else 'N/A' }}</p>
                        <p><strong>Location:</strong> {{ event.location | default('N/A') }}</p>
                        <p><strong>Venue:</strong> {{ event.venue | default('N/A') }}</p>
                        <p><strong>Category:</strong> {{ event.event_category.name if event.event_category else 'N/A' }}</p>
                        <p><strong>Genre:</strong> {{ event.genre | default('N/A') }}</p>
                        <p><strong>Age Limit:</strong> {{ event.age_limit if event.age_limit is not none else 'N/A' }}{{ '+' if event.age_limit and event.age_limit > 0 else '' }}</p>
                        <p><strong>Event Length:</strong> {{ event.length | default('N/A') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if event.artist_info %}
    <div class="row mt-4">
        <div class="col-sm-12 justify-content-center">
            <div class="card card-slider rounded-4 overflow-hidden">
                <div class="card-header fw-bold">Artist Information</div>
                <div class="card-body">
                    <p>{{ event.artist_info }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if event.description %}
    <div class="row mt-4">
        <div class="col-sm-12">
            <div class="card card-slider rounded-4 overflow-hidden">
                <div class="card-header fw-bold">Event Description</div>
                <div class="card-body">
                    <p>{{ event.description }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if event.policies %}
    <div class="row mt-4">
        <div class="col-sm-12">
            <div class="card card-slider rounded-4 overflow-hidden">
                <div class="card-header fw-bold">Event Policies</div>
                <div class="card-body">
                    <p>{{ event.policies }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if event.facebook or event.instagram or event.twitter or event.youtube or event.twitch %}
    <div class="row mt-4">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Follow Us:</h5>
                    {% if event.facebook %}<a href="{{ event.facebook }}" target="_blank" class="btn btn-outline-primary m-1">Facebook</a>{% endif %}
                    {% if event.instagram %}<a href="{{ event.instagram }}" target="_blank" class="btn btn-outline-danger m-1">Instagram</a>{% endif %}
                    {% if event.twitter %}<a href="{{ event.twitter }}" target="_blank" class="btn btn-outline-info m-1">Twitter</a>{% endif %}
                    {% if event.youtube %}<a href="{{ event.youtube }}" target="_blank" class="btn btn-outline-danger m-1">YouTube</a>{% endif %}
                    {% if event.twitch %}<a href="{{ event.twitch }}" target="_blank" class="btn btn-outline-purple m-1">Twitch</a>{% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="container mt-4 mb-3">
        <div class="row">
            <div class="col-12 text-center">
                {% if current_user.is_authenticated and event.created_by == current_user.id %}
                    <a href="{{ url_for('event.edit_event', id=event.id) }}" class="btn btn-warning btn-lg">Edit Event</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container mt-4 mb-5">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Comments ({{ event.comments.count() }})</h5>
                        
                        {% if current_user.is_authenticated %}
                        <form method="POST" action="{{ url_for('event.comment', id=event.id) }}" class="mb-4">
                            {{ form.csrf_token }}
                            <div class="mb-3">
                                {{ form.text.label(class="form-label") }}
                                {{ form.text(class="form-control", rows="3", placeholder="Write your comment here...") }}
                                {% if form.text.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.text.errors %}
                                            <span>{{ error }}</span><br>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {{ form.submit(class="btn btn-primary") }}
                        </form>
                        {% else %}
                        <div class="alert alert-info">
                            Please <a href="{{ url_for('auth.login', next=request.url) }}">login</a> to post comments.
                        </div>
                        {% endif %}

                        <hr>
                        <h6>Posted Comments:</h6>
                        {% if event.comments.all() %}
                            {% for comment_item in event.comments.order_by(Comment.created_at.desc()).all() %}
                            <div class="card mb-3 bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="card-subtitle mb-2 text-muted">
                                            {{ comment_item.user.firstName if comment_item.user else 'Anonymous' }}
                                            {% if comment_item.user and comment_item.user.surname %}{{ comment_item.user.surname }}{% endif %}
                                        </h6>
                                        <small class="text-muted">
                                            {{ comment_item.created_at.strftime('%Y-%m-%d %H:%M') }}
                                            {% if comment_item.is_edited %}(edited){% endif %}
                                        </small>
                                    </div>
                                    <p class="card-text">{{ comment_item.text }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="alert alert-secondary">
                            No comments yet. Be the first to comment!
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-danger text-center" role="alert">
      Event not found or details could not be loaded.
    </div>
    {% endif %}
</main>
{% endblock %}